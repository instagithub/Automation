{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "VE Tomcat",
  "Parameters" : {
    "securityGroup" : {
      "Type" : "String",
      "Default" : "sg-5e9b952e"
    },
    "hostedZoneId" : {
      "Type" : "String",
      "Default" : "ZCQV0SSFIMZ43"
    },
    "hostedZoneName" : {
      "Type" : "String",
      "Default" : "dev.pega.io."
    },
    "certificateArn" : {
      "Type" : "String",
      "Default" : "arn:aws:acm:us-east-1:045654838477:certificate/59ab40ff-7a7b-4439-a0fb-ff9bf12d28b4"
    },
    "subnetIDs" : {
      "Type" : "CommaDelimitedList",
      "Default" : "subnet-05150728,subnet-3ce5ec67"
    },
    "HostEc2Id" : {
      "Type" : "String",
      "Default" : "i-01b8b375eb712bb73"
    },
    "PRPCPort" : {
      "Type" : "Number",
      "Default" : "32776"
    }
  },
  "Resources" : {
    "LoadBalancer" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "Subnets" : {"Ref" : "subnetIDs" },
        "Instances" : [ {"Ref" : "HostEc2Id"} ],
        "CrossZone" : true,
        "SecurityGroups" : [ { "Ref":"securityGroup" }],
        "Listeners" : [ {
          "LoadBalancerPort" : "443",
          "InstancePort" : {"Ref" : "PRPCPort"},
          "Protocol" : "HTTPS",
          "InstanceProtocol" : "HTTP",
          "SSLCertificateId": { "Ref" : "certificateArn" }
        } ],
        "HealthCheck" : {
          "Target" : { "Fn::Join" : [ "", ["TCP:", {"Ref" : "PRPCPort"}]]},
          "HealthyThreshold" : "2",
          "UnhealthyThreshold" : "10",
          "Interval" : "10",
          "Timeout" : "5"
        }
      }
    },
    "recordset": {
      "Type" : "AWS::Route53::RecordSet",
      "DependsOn": "LoadBalancer",
      "Properties" : {
        "Comment" : "pipeline's record",
        "HostedZoneId" : {"Ref":"hostedZoneId"},
        "Name" : {"Fn::Join" : [ ".", [ { "Ref" : "AWS::StackName" } , {"Ref":"hostedZoneName"} ] ]},
        "AliasTarget": {
          "DNSName" : {"Fn::GetAtt": ["LoadBalancer","DNSName"]},
          "EvaluateTargetHealth" : false,
          "HostedZoneId" : {"Fn::GetAtt": ["LoadBalancer","CanonicalHostedZoneNameID"]}
        },
        "Type" : "A"
      }
    }
  },
  "Outputs" : {
    "HTTPSUrl": {
      "Value": {"Fn::Join" : [ "", [ "https://", { "Ref" : "recordset" } ,"/prweb" ] ]}
    },
    "ECSALB":{
      "Description":"ELB DNS URL",
      "Value":{ "Fn::Join":[ "", [ "https://", { "Fn::GetAtt":[ "LoadBalancer","DNSName"] },"/prweb" ] ]  }
    }
  }
}