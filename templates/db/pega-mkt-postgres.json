{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "VE Postgres",
  "Parameters" : {
    "clustername" : {
      "Description" : "ECS Cluster name",
      "Type" : "String"
    },
    "vid" : {
      "Description" : "ve request-id",
      "Type" : "String",
      "Default" : ""
    },
    "testtype" : {
      "Description" : "junit or ui",
      "Type" : "String"
    },
    "elkhost" : {
      "Description" : "logstash url",
      "Type" : "String",
      "Default" : ""
    },
    "artifactoryURL" : {
      "Type" : "String",
      "Default" : "https://cirrus-cache.pega.io/artifactory"
    },
    "artifactoryUser" : {
      "Type" : "String",
      "Default" : ""
    },
    "artifactoryPassword" : {
      "Type" : "String",
      "Default" : ""
    },
    "dbname" : {
      "Type" : "String",
      "Default" : "postgres"
    },
    "timezone" : {
      "Type" : "String",
      "Default" : "America/New_York"
    },
    "dbusername": {
      "Type": "String",
      "Default": "postgres"
    },
    "dbpassword" : {
      "Type" : "String",
      "Default" : "postgres"
    },
    "ruleschema" : {
      "Type" : "String",
      "Default" : "public"
    },
    "dataschema" : {
      "Type" : "String",
      "Default" : "public"
    },
    "tarballGroup" : {
      "Type" : "String",
      "Default" : "com.pega.prpc.docker"
    },
    "tarballArtifact" : {
      "Type" : "String",
      "Default" : "prpc-data-coreAssembly-postgres-9.4-ss-st-smoke"
    },
    "tarballVersion" : {
      "Type" : "String",
      "Default" : "DEFAULT"
    },
    "tarballRepo" : {
      "Type" : "String",
      "Default" : "builds-prpc-val-local"
    },
    "tarballClassifier" : {
      "Type" : "String",
      "Default" : "DEFAULT"
    },
    "postgresImageName" : {
      "Type" : "String",
      "Default" : "docker-dev-local.bin.pega.io/postgres-image:latest"
    },
    "dbFilebeatImageName" : {
      "Type" : "String",
      "Default" : "docker-dev-local.bin.pega.io/db-filebeat:5.6.2"
    }
  },
  "Resources" : {
    "taskdefinition": {
      "Type": "AWS::ECS::TaskDefinition",
      "Properties" : {
        "ContainerDefinitions" : [
          {
            "Name": "db-filebeat-1",
            "Cpu": "5",
            "Memory" : 512,
            "Image": { "Ref" : "dbFilebeatImageName" },
            "ReadonlyRootFilesystem" : false,
            "Privileged" : true,
            "VolumesFrom": [
              {
                "SourceContainer": "postgres"
              }
            ],
            "Environment": [
              {
                "Name": "vid",
                "Value":{ "Ref" : "vid" }
              },
              {
                "Name": "elk_host",
                "Value":{ "Ref" : "elkhost" }
              },
              {
                "Name": "test_type",
                "Value":{ "Ref" : "testtype" }
              },
              {
                "Name": "ve",
                "Value":"true"
              }
            ]
          },
          {
            "Name": "postgres",
            "Cpu": "20",
            "Memory" : 8192,
            "ReadonlyRootFilesystem" : false,
            "Privileged" : true,
            "Image":{ "Ref" : "postgresImageName" } ,
            "PortMappings": [{
              "HostPort": 0,
              "ContainerPort": 5432
            }],
            "Command" : [ "postgres"],
            "Environment": [{
              "Name": "ARTIFACTORY_URL",
              "Value":{ "Ref" : "artifactoryURL" }
            },
              {
                "Name": "TARBALL_USERNAME",
                "Value":{ "Ref" : "artifactoryUser" }
              },
              {
                "Name": "TARBALL_PASSWORD",
                "Value":{ "Ref" : "artifactoryPassword" }
              },
              {
                "Name": "TARBALL_GROUP",
                "Value":{ "Ref" : "tarballGroup" }
              },
              {
                "Name": "TARBALL_ARTIFACT",
                "Value": { "Ref" : "tarballArtifact" }
              },
              {
                "Name": "TARBALL_VERSION",
                "Value": { "Ref" : "tarballVersion" }
              },
              {
                "Name": "TARBALL_CLASSIFIER",
                "Value": { "Ref" : "tarballClassifier" }
              },
              {
                "Name": "TARBALL_REPO",
                "Value": { "Ref" : "tarballRepo" }
              },
              {
                "Name": "ve",
                "Value":"true"
              },
              {
                "Name": "vid",
                "Value":{ "Ref" : "vid" }
              },
              {
                "Name": "elk_host",
                "Value":{ "Ref" : "elkhost" }
              },
              {
                "Name": "test_type",
                "Value":{ "Ref" : "testtype" }
              }]
          }]
      }
    },
    "service": {
      "Type": "AWS::ECS::Service",
      "Properties" : {
        "Cluster": { "Ref" : "clustername" },
        "DesiredCount": "1",
        "TaskDefinition" : {"Ref":"taskdefinition"}
      }
    }
  },
  "Outputs" : {
    "taskdef" : {
      "Value" : {"Ref":"taskdefinition"}
    }
  }
}